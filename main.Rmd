---
title: "Final Project"
output: pdf_document
---

```{r, echo=FALSE}
library(ggplot2)
library(gridExtra)
library(dplyr)
library(reshape2)
source("functions.R")
source("binary_sampler.R")
source("plot_functions.R")
# import protein altering sheet
raw_PA <- readxl::read_excel("data/ukb_biomarker_supp.xlsx", sheet="ST7", skip=1)
# import noncoding sheet
raw_NC <- readxl::read_excel("data/ukb_biomarker_supp.xlsx", sheet="ST8", skip=1)
df <- bind_rows(raw_PA, raw_NC)
```

## Summary statistics summary
```{r}
# variant count frequencies
p1 <- ggplot(as.data.frame(table(df$ID)), aes(x=Freq)) + 
  geom_histogram(bins=25, color="white") + 
  ggtitle("Freq of counts of # of traits variants affect") + 
  xlab("# of traits affected") + ylab("Frequency") + theme_minimal()
# histogram of betas
p2 <- ggplot(df, aes(x=BETA)) + geom_histogram(aes(y=..density..),bins=100,color="white") + 
  theme_minimal() + ggtitle("Distr of betas") + xlim(c(-0.5,0.5))
# try to fit a normal and see how it looks
d_estimate <- MASS::fitdistr(df$BETA, "normal")$estimate 
p2 <- p2 + stat_function(fun=dnorm, args=d_estimate, color="red")
grid.arrange(p1,p2,ncol=2)
```

## Rint
```{r}
df$BETA_rint <- qnorm((rank(df$BETA)-0.5)/length(df$BETA))
ggplot(df, aes(x=BETA_rint)) + geom_histogram(bins=15, color="white") + theme_minimal() + ggtitle("PA")
```

```{r}
# num traits affected each variant affects
variants_binary <- table(df$ID, df$Trait, useNA="no")
counts <- data.frame(rowSums(variants_binary))
counts <- cbind(variant=rownames(counts), counts)
rownames(counts) <- 1:nrow(counts)
# num variants that influence more than one trait
nrow(counts[counts$rowSums.variants_binary.>1,])
```

# Binary sample

### K = 6
```{r}
niter <- 100
res <- gibbs(variants_binary, K=6, R=ncol(variants_binary), niter=niter)
```

```{r}
# visualize gibbs trajectory
```


```{r}
table(res$z[niter,])/nrow(variants_binary)
# df cols: ID, assignment, P(1), P(2), P(3), P(4), P(5), P(6)
assignments <- get_cluster_assignments(variants_binary, res, niter=niter)
```

```{r}
# stacked barplot of assignment probabilities (see plots folder for full plot)
structure_plot(assignments, n=100)
```

```{r}
# proportion of variants in each cluster for each trait
df$assignment <- sapply(df$ID, function(x) {assignments[assignments$ID==x, ]$assignment})
t <- table(df$Trait, df$assignment)
# doesn't seem to nec match pre-defined categories but looks like it makes biological sense...
round(table(df$Trait, df$assignment)/rowSums(t), 2)
```

### K = 3
```{r}
res3 <- gibbs(variants_binary, K=3, R=ncol(variants_binary), niter=100)
assignments3 <- get_cluster_assignments(x=variants_binary, res=res3, niter=100)
structure_plot(assignments3, n=100)
# examine by trait
df$assignment3 <- sapply(df$ID, function(x) {assignments3[assignments3$ID==x, ]$assignment})
t3 <- table(df$Trait, df$assignment3)
round(table(df$Trait, df$assignment3)/rowSums(t3), 2)
```


